<div class="content-section">
    <p>Data is collected across five disease categories. Initial data release contains data collected from four of five categories (pediatric data to be incorporated in subsequent dataset releases.</p>

    <p>Participants are recruited across different academic institutions from "high volume expert clinics" based on diagnosis and inclusion/exclusion criteria outlined below <strong>(Table 1)</strong>.</p>

    <p><strong>High Volume Expert Clinics:</strong> Outpatient clinics within hospital systems or academic institutions that have developed an expertise in a specific disease area and see more than 50 patients per month from the same disease category. Ex: Asthma/COPD pulmonary specialty clinic.</p>

    <p>Data is collected in the clinic with the assistance of a trained researched assistant. Future data collection will also occur remotely, however remote data collection did not occur with initial dataset being released. Voice samples are collected prospectively using a custom software application (Bridge2AI-Voice app) with the Bridge2AI-Voice protocols.</p>

    <p><strong>Clinical validation:</strong> Clinical validation is performed by qualified physician or practitioner based on established gold standards for diagnosis <strong>(Table 1)</strong>.</p>

    <p><strong>Acoustic Tasks:</strong> Voice, breathing, cough, and speech data are recorded with the app. A total of 22 acoustic Tasks are recorded through the app <strong>(Table 2)</strong>.</p>

    <p><strong>Demographic surveys and confounders:</strong> Detailed demographic data and surveys about confounding factors such as smoking and drinking history is collected through the smartphone application.</p>

    <p><strong>Validated Questionnaires:</strong> The Bridge2AI-Voice protocols contain validated tools and questionnaires for each disease category within the app for data collection <strong>(Table 3)</strong>.</p>

    <p><strong>Other Multimodal Data:</strong> The rest of the multimodal data including imaging, genomic data (for the neuro cohort), laryngoscopy imaging and other EHR data is extracted from different sites independently and will be uploaded through the REDCAP database. Please note that no external data is released in this v2.0.0.</p>

    <p>Please see publication for protocol development description:</p>
    <blockquote>
        Bensoussan, Yael, et al. "Developing Multi-Disorder Voice Protocols: A team science approach involving clinical expertise, bioethics, standards, and DEI." Proc. Interspeech 2024. 2024. <a href="https://www.isca-archive.org/interspeech_2024/bensoussan24_interspeech.html" target="_blank">https://www.isca-archive.org/interspeech_2024/bensoussan24_interspeech.html</a>.
    </blockquote>

    <p>The supporting REDCap Data Dictionary, Metadata and Instrument PDFs are available at <a href="https://github.com/eipm/bridge2ai-redcap" target="_blank">https://github.com/eipm/bridge2ai-redcap</a>.</p>

    <p>When using the REDCap Data Dictionary and Metadata please cite:</p>
    <blockquote>
        Bensoussan, Y., Ghosh, S. S., Rameau, A., Boyer, M., Bahr, R., Watts, S., Rudzicz, F., Bolser, D., Lerner-Ellis, J., Awan, S., Powell, M. E., Belisle-Pipon, J.-C., Ravitsky, V., Johnson, A., Zisimopoulos, P., Tang, J., Sigaras, A., Elemento, O., Dorr, D., â€¦ Bridge2AI-Voice. (2024). eipm/bridge2ai-redcap. Zenodo. <a href="https://zenodo.org/doi/10.5281/zenodo.12760724" target="_blank">https://zenodo.org/doi/10.5281/zenodo.12760724</a>.
    </blockquote>

    <p>Protocols can be found in the Bridge2AI-Voice documentation for v2.0.0 of the dataset at <a href="https://kind-lab.github.io/vbai-fhir/protocol.html" target="_blank">https://kind-lab.github.io/vbai-fhir/protocol.html</a>.</p>
</div>

<div class="table-container">
    <h3>Table 1 - Disease cohort inclusion/exclusion criteria and validation methods</h3>
    <div class="table-responsive" id="disease-cohort-table">
        <!-- Fallback static table in case JavaScript fails -->
        <noscript>
            <table>
                <thead>
                    <tr>
                        <th>Disease Cohort</th>
                        <th>Diagnosis</th>
                        <th>Inclusion Criteria</th>
                        <th>Exclusion Criteria</th>
                        <th>Gold Standard Validation Methods</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="bold-cell">Voice Disorders Cohort</td>
                        <td>Laryngeal Cancer</td>
                        <td>Active laryngeal cancer T1-T4 Biopsy proven</td>
                        <td>Previously treated laryngeal cancer with no evidence of disease on scope</td>
                        <td>Laryngoscopy Images Stroboscopy Videos</td>
                    </tr>
                    <tr>
                        <td class="bold-cell">Voice Disorders Cohort</td>
                        <td>Laryngitis</td>
                        <td>Acute laryngitis Chronic laryngitis Bacterial laryngitis</td>
                        <td>Subjective laryngitis without evidence on scope</td>
                        <td>Laryngoscopy Images Stroboscopy Videos</td>
                    </tr>
                </tbody>
            </table>
        </noscript>
    </div>
</div>

<div class="table-container">
    <h3>Table 2 - Acoustic Tasks in Protocol</h3>
    <div class="table-responsive" id="acoustic-tasks-table">
        <!-- Fallback static table in case JavaScript fails -->
        <noscript>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Task</th>
                        <th>Description</th>
                        <th>Part</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="bold-cell">Non Voice/Non Speech</td>
                        <td>Respiration Part A</td>
                        <td>Breathing sounds</td>
                        <td>A</td>
                    </tr>
                    <tr>
                        <td class="bold-cell">Non Voice/Non Speech</td>
                        <td>Cough part A</td>
                        <td>Voluntary Cough</td>
                        <td>A</td>
                    </tr>
                </tbody>
            </table>
        </noscript>
    </div>
</div>

<div class="table-container">
    <h3>Table 3 - Validated Questionnaires integrated into App</h3>
    <div class="table-responsive" id="validated-questionnaires-table">
        <!-- Fallback static table in case JavaScript fails -->
        <noscript>
            <table>
                <thead>
                    <tr>
                        <th>Validated Questionnaire</th>
                        <th>Voice Disorders</th>
                        <th>Respiratory</th>
                        <th>Mood/Psychiatric</th>
                        <th>Neurological</th>
                        <th>Controls</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="bold-cell">Voice Handicap Index-10 (VHI-10)</td>
                        <td class="center-align">X</td>
                        <td class="center-align">X</td>
                        <td class="center-align">X</td>
                        <td class="center-align">X</td>
                        <td class="center-align">X</td>
                    </tr>
                    <tr>
                        <td class="bold-cell">Patient Health Questionnaire (PHQ-9)</td>
                        <td class="center-align">X</td>
                        <td class="center-align">X</td>
                        <td class="center-align">X</td>
                        <td class="center-align">X</td>
                        <td class="center-align">X</td>
                    </tr>
                </tbody>
            </table>
        </noscript>
    </div>
</div>

<style>
    .content-section {
        margin-bottom: 2rem;
    }

    blockquote {
        border-left: 4px solid var(--nu-purple);
        padding-left: 1rem;
        margin: 1rem 0;
        color: var(--nu-gray-dark);
    }

    .table-container {
        margin: 2rem 0;
    }

    .table-responsive {
        overflow-x: auto;
        margin-top: 1rem;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }

    .center-align {
        text-align: center;
    }

    .bold-cell {
        font-weight: bold;
    }
</style>

<script>
    // Embedded CSV data as fallback
    const DISEASE_COHORT_CSV = `Disease Cohort,Diagnosis,Inclusion Criteria,Exclusion Criteria,Gold Standard Validation Methods
Voice Disorders Cohort,Laryngeal Cancer,"Active laryngeal cancer T1-T4 Biopsy proven (if no biopsy at time of collection and suspicion is very high, provider will have to go back to confirm in the clinical validation section after the biopsy is obtained) ",Previously treated laryngeal cancer with no evidence of disease on scope,Laryngoscopy Images Stroboscopy Videos
Voice Disorders Cohort,Laryngitis,Acute laryngitis Chronic laryngitis Bacterial laryngitis Fungal laryngitis Autoimmune laryngitis *need to have evidence of information of the vocal cords on laryngoscopy as well as dysphonia,Subjective laryngitis without evidence on scope,Laryngoscopy Images Stroboscopy Videos
Voice Disorders Cohort,Pre-cancerous lesions,Keratosis Leukoplakia (note if with or without dysplasia),Low grade -,Laryngoscopy Images Stroboscopy Videos
Voice Disorders Cohort,"Benign Lesions of the vocal cord (nodule, polyp, cyst) ",Vocal fold nodules Vocal fold polyp Vocal fold cyst Reinke's Edema Vocal fold ulcers Recurrent respiratory Papilloma Fibrous mass Rheumatoid nodules Recurrent Laryngeal Papilloma (RLP),Patient has received surgery for any condition and does not have evidence of pathology when scoped Immediate post op prior less than 30 days from laryngeal surgery,Laryngoscopy Images Stroboscopy Videos`;

    const ACOUSTIC_TASKS_CSV = `Name,Task,Description,Part
Non Voice/Non Speech,Respiration Part A,Breathing sounds,A
Non Voice/Non Speech,Cough part A,Voluntary Cough,A
Non Voice/Non Speech,Breath Sounds,Breathing sounds,Resp
Non Voice/Non Speech,Voluntary Cough,Voluntary Cough,Resp
Voice/Non Speech,Prolonged Vowel,vowel /e/,A
Voice/Non Speech,Maximum Phonation Time,vowel /e/,A
Voice/Non Speech,Glides,Lowest to Highest /e/,A
Voice/Non Speech,Loudness,/Hey/,A
Voice/Non Speech,Diadochokinesis,/pa/ta/ka/ /buttercup/,A
Speech,Rainbow Passage,validated passage,A`;

    const VALIDATED_QUESTIONNAIRES_CSV = `Validated Questionnaire,Voice Disorders,Respiratory,Mood/Psychiatric,Neurological,Controls
Voice Handicap Index-10 (VHI-10),X,X,X,X,X
Patient Health Questionnaire (PHQ-9),X,X,X,X,X
General Anxiety Disorder (GAD-7),X,X,X,X,X
Positive and Negative Affect Schedule (PANAS),,,X,,X
Custom Affect scale,,,X,,X
Post-Traumatic Stress Disorder Test (PTSD) Adult,,,X,,X
Attention Deficit and Hyperactivity Disorder Questionnaire (ADHD-Adult),,,X,,X
The Diagnostic and Statistical Manual of Mental Disorders (DSM-5 Adult),,,X,,X
Dyspnea Index (DI),,X,,,X`;

    // Helper function to fetch a CSV file with fallback to embedded data
    async function fetchWithFallback(path, fallbackPath, embeddedData) {
        try {
            console.log('Trying to fetch from:', path);
            const response = await fetch(path);
            if (response.ok) {
                return await response.text();
            }

            console.log(`Failed to fetch from ${path}, trying fallback: ${fallbackPath}`);
            try {
                const fallbackResponse = await fetch(fallbackPath);
                if (fallbackResponse.ok) {
                    return await fallbackResponse.text();
                }
            } catch (fallbackError) {
                console.log('Fallback fetch failed, using embedded data');
            }

            // If both fetches fail, use the embedded data
            console.log('Using embedded data as last resort');
            return embeddedData;
        } catch (error) {
            console.error('Error fetching data:', error);
            // Return embedded data as last resort
            return embeddedData;
        }
    }

    // Function to create a direct HTML table from embedded data
    function createDirectHtmlTable(containerId, csvData, centerValues = []) {
        try {
            const tableHtml = createTableFromCSV(csvData, centerValues);
            document.getElementById(containerId).innerHTML = tableHtml;
            return true;
        } catch (error) {
            console.error(`Error creating direct HTML table for ${containerId}:`, error);
            return false;
        }
    }

    // Function to load CSV data and create tables
    async function loadTableData() {
        try {
            // Get the baseurl from the config or default to empty string
            const baseUrl = '/sprout-website';
            console.log('Loading tables with baseUrl:', baseUrl);

            // Add a status message while loading
            document.querySelectorAll('.table-responsive').forEach(container => {
                container.innerHTML = '<p>Loading table data...</p>';
            });

            // Try to load all tables with fallback paths and embedded data
            try {
                // Disease cohort table
                const diseaseData = await fetchWithFallback(
                    `${baseUrl}/tables/Disease_cohort_inclusion_exclusion_criteria.csv`,
                    'tables/Disease_cohort_inclusion_exclusion_criteria.csv',
                    DISEASE_COHORT_CSV
                );
                document.getElementById('disease-cohort-table').innerHTML = createTableFromCSV(diseaseData);

                // Acoustic tasks table
                const acousticData = await fetchWithFallback(
                    `${baseUrl}/tables/Acoustic_Tasks_Protocol.csv`,
                    'tables/Acoustic_Tasks_Protocol.csv',
                    ACOUSTIC_TASKS_CSV
                );
                document.getElementById('acoustic-tasks-table').innerHTML = createTableFromCSV(acousticData);

                // Validated questionnaires table
                const questionnairesData = await fetchWithFallback(
                    `${baseUrl}/tables/Validated_Questionnaires.csv`,
                    'tables/Validated_Questionnaires.csv',
                    VALIDATED_QUESTIONNAIRES_CSV
                );
                document.getElementById('validated-questionnaires-table').innerHTML = createTableFromCSV(questionnairesData, ['X']);

                console.log('All tables loaded successfully');
            } catch (fetchError) {
                console.error('Error fetching table data:', fetchError);

                // Final fallback: create tables directly from embedded data
                console.log('Using direct HTML table creation as final fallback');
                let success = true;

                success = createDirectHtmlTable('disease-cohort-table', DISEASE_COHORT_CSV) && success;
                success = createDirectHtmlTable('acoustic-tasks-table', ACOUSTIC_TASKS_CSV) && success;
                success = createDirectHtmlTable('validated-questionnaires-table', VALIDATED_QUESTIONNAIRES_CSV, ['X']) && success;

                if (!success) {
                    throw new Error('Failed to create direct HTML tables');
                }
            }
        } catch (error) {
            console.error('Error loading table data:', error);
            document.querySelectorAll('.table-responsive').forEach(container => {
                container.innerHTML = `
                    <div style="color: red; padding: 10px; border: 1px solid red; margin: 10px 0;">
                        <p><strong>Error loading table data:</strong></p>
                        <p>${error.message}</p>
                        <p>Please check the browser console for more details.</p>
                        <p>Try refreshing the page or viewing the tables in the original Streamlit application.</p>
                    </div>
                `;
            });
        }
    }

    // Function to parse CSV and create HTML table
    function createTableFromCSV(csvText, centerValues = []) {
        // More robust CSV parsing that handles quoted fields with commas
        function parseCSVLine(line) {
            const result = [];
            let cell = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"' && (i === 0 || line[i-1] !== '\\')) {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(cell.trim());
                    cell = '';
                } else {
                    cell += char;
                }
            }

            // Add the last cell
            result.push(cell.trim());

            // Clean up quotes from cells
            return result.map(cell => {
                if (cell.startsWith('"') && cell.endsWith('"')) {
                    return cell.substring(1, cell.length - 1).trim();
                }
                return cell.trim();
            });
        }

        const rows = csvText.trim().split('\n');
        const headers = parseCSVLine(rows[0]);

        let tableHTML = '<table>';

        // Add headers
        tableHTML += '<thead><tr>';
        headers.forEach(header => {
            tableHTML += `<th>${header}</th>`;
        });
        tableHTML += '</tr></thead>';

        // Add body
        tableHTML += '<tbody>';
        for (let i = 1; i < rows.length; i++) {
            const cells = parseCSVLine(rows[i]);
            tableHTML += '<tr>';

            cells.forEach((cell, index) => {
                // Apply special formatting
                if (index === 0) {
                    tableHTML += `<td class="bold-cell">${cell}</td>`;
                } else if (centerValues.includes(cell)) {
                    tableHTML += `<td class="center-align">${cell}</td>`;
                } else {
                    tableHTML += `<td>${cell}</td>`;
                }
            });

            tableHTML += '</tr>';
        }
        tableHTML += '</tbody></table>';

        return tableHTML;
    }

    // Load tables when the content is loaded
    document.addEventListener('DOMContentLoaded', loadTableData);

    // Also try to load tables immediately in case the page is already loaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(loadTableData, 100);
    }
</script>
